# 字符串

## string的哪些方法会创建对象

---

现在有如下代码，请问代码中创建了几个对象？

```csharp
public string MakeString()
{
    string s = "abc";
    s = s + "de";
    s = s.substring(2, 4);
    s = s.toUpperCase();
    return s.toString();
}
```

首先看第一句，`"abc"` 是字符串常量，会专门存储在字符串常量区。如果字符串常量区已经有了这个字符串，那么 s 相当于直接对其引用，不会创建对象。再来看第二句，当使用 `+` 连接字符串时，`"de"` 会转换成 string 类型与 s 进行合并，因此这一条语句会创建一个对象。第三、四句都会生成一个新的对象返回，因此会创建两个对象。而第五句其实是直接返回 `this`，不会创建对象。总共创建了三个对象。

再来看下面的代码：

```csharp
string s = new string("abc");
```

先看第一句，如果 `"abc"` 已经在字符串常量区，那么就不会新建对象，而 new 则是会创建一个新对象返回给 s。

## String与StringBuilder

---

### string

string 是引用类型，派生自 System.Object，因此它的值是在堆上分配的。当我们对是 string 进行初始化后，它的内容都是确定不变的了。什么意思呢？看下面的例子：

```csharp
string s = "I am ";
s += "XXX";
```

上面的代码看似是对 s 进行扩充，但实际上系统会新分配一个内存来存储 `I am XXX`，并且让 s 指向这个新内存。

C# 为了避免创建多个相同的字符串，它会将新字符串存储到一个哈希表里。如果存在多个对象指向同一个字符串，那么它们所指向的内容都是一样的：

```csharp
string a = "I am XXX";
string b = "I am XXX";  // a和b指向的是同一片内存
```

注意，如果你是使用 new 来初始化字符串，那么这个字符串是不会记录到哈希表中的。

### StringBuilder

由于 string 在修改字符串时会分配新内存，因此在对大量字符串进行拼接时，可以使用 StringBuilder。

StringBuilder 内部有 char 数组，可以自由地对其中的内容进行增删改。当容量不足时，StringBuilder 会重新分配一片内存，容量是原来的两倍，而旧内存则会被回收。

```csharp
// 指定StringBuilder的内容与容量
StringBuilder myStringBuilder = new StringBuilder("Hello World!", 25);
// 修改容量
myStringBuilder.Capacity = 50;
// 将字符串拼接到myStringBuilder尾部
myStringBuilder.Append(" I am XXX!");
// 格式化拼接
int num = 10;
myStringBuilder.AppendFormat("{0:C}", num);
// 将字符串插入到指定位置
myStringBuilder.Insert(6,"Well, ");
// 移除指定位置的字符，StringBuilder会缩短
myStringBuilder.Remove(6,11);
// 将!替换为?
myStringBuilder.Replace('!', '?');
```