# ECS入门

这篇笔记将介绍 Unity 最新提供的 ECS 框架。ECS 框架其实很早就存在了，只不过很少会有公司去使用而已。在开始介绍 ECS 前，建议各位先看看暴雪在 GDC2017 做的技术分享：[《守望先锋》架构设计与网络同步](https://gameinstitute.qq.com/community/detail/114516)。

## ECS概述

---

### 什么是ECS

ECS 即 Entity（实体）、Component（组件）、System（系统），这三大元素构成了 ECS 框架。该框架的核心在于 Component 和 System。

Entity 可以看做是对象，但和一般的游戏对象（比如 GameObject）不同，它仅仅只包含数据，不包含方法。实体对应一个 ID，它是由多个组件所组成的集合，它意义在于生命周期的管理。

Component 可以认为是对象属性，它是无行为的，所有可以单独使用的对象都可以作为组件，比如对象的名称可以是一个组件，对象的位置又可以是一个组件。每个 Entity 都是由多个 Component 组成，共享一个生命周期。

System 可以看做是模块，它是无状态的。ECS 中的 System 不同于一般意义上的系统，每个模块只专注于干好一件事情。举个例子，碰撞系统只关心对象的体积和位置，不关心对象的名称、音效、特效等等属性。它也不一定会关心游戏世界中的所有对象，比如有些装饰物不会参与碰撞。因此对于每个系统而言，有必要筛选出所有它感兴趣的对象。

### 为什么要有ECS

很多游戏引擎都是根据面向对象来设计的，游戏中的各种东西都可以是对象。每个对象都有一个 Update 方法，框架会依次遍历所有对象的 Update 方法，然后执行相应的逻辑。Unity 中提供了多种 Update 方法，以供开发者在同一帧的不同时机调用。

这种做法有很多缺陷，因为游戏对象通常是许多部分的集合，而不同业务模块所关心的部分往往是不同的，比如渲染模块不关心网络连接，碰撞检测模块不会关心玩家的属性、道具等。虽然把游戏对象的各种属性聚合在一起形成对象是没错的，但对于不同的模块而言，如果针对聚合对象做处理的话，会让模块的内聚性变差，模块间也会产生不必要的耦合。我们在实际开发时为了减少误差，可能会让服务端和客户端共用一部分代码。如果客户端的代码耦合较为紧密，那么可能就无法做到这一点。

ECS 框架的业务循环就是在调用不同的系统，每个系统都会遍历自己感兴趣的对象，而那些不感兴趣的则不会去管看。对于守望先锋这类游戏来说，ECS 框架是很符合其需求的。比如 A 攻击了 B，那么这件事情就是发生在 A 和 B 之间。传统的框架中你经常会纠结伤害计算放在 A 的方法中还是 B 的方法中，而 ECS 则只需要放在伤害计算系统中即可，这个系统只关心那些与伤害有关的一小部分数据集合。

总之，ECS 框架就是把复杂的问题拆分开来，提高每个子系统的内聚性。