# 矩阵变换

这一篇笔记将对矩阵的应用进行拓展。

## 几种常见的矩阵变换

---

在三维渲染中，矩阵可以视为是一种变换，这些变化一般包含了旋转、缩放、平移等。开发人员希望给定一个点或者向量，再给定一个变换（比如把点平移，或者把向量旋转一下），就可以通过某种数学运算得到新的点和向量。那么矩阵就是用来解决这个问题的。

### 什么是变换

所谓的变换，是指我们将一些数据，比如点、矢量、颜色等通过某种方式进行转换的过程。我们先来看一下**线性变换**，它满足如下两个条件：

$$ f(x)+f(y)=f(x+y) $$
$$ kf(x)=f(kx) $$

举个例子，缩放就是一个线性变换。我们假设 $f(x)=2\boldsymbol x$，那么这就表示一个大小为 2 的统一缩放，即经过变换后向量 $\boldsymbol x$ 的模将放大两倍。同样的，旋转也是一种线性变换。对于线性变换来说，如果要对一个三维向量进行变换，那么只需要使用 3X3 的矩阵就能够表示所有的线性变换。除了上述的两种，线性变换还有很多，不过用的最多的还是旋转和缩放变换。

不过呢，仅有线性变换是不够的，我们还需要考虑平移变换，比如 $f(x)=\boldsymbol x + (1,2,3)$。但问题是，平移变换并不满足线性变换的两个条件，因而也无法用 3X3 的矩阵来表示平移变换。这是我们不希望看到的，因为平移变换也是很常见的一种变换。

基于这种需求，**仿射变换**出现了。仿射变换是线性变换和平移变换的集合，它使用一个 4X4 矩阵来表示。为此，我们需要把向量拓展到四维空间，也就是**齐次坐标空间**。

### 齐次坐标

当我们将三维向量扩展成四维向量时，就成为了**齐次坐标**。齐次坐标可以继续往下拓展，但这不在我们的讨论范围内。

既然齐次坐标是一个四维向量，那么第四个值 $w$ 是怎么来的呢？很简单，对于一个点而言，从三维坐标转换成齐次坐标是把 $w$ 设为 1，而对于向量而言则是设为 0。也就是说，如果我们用 4X4 矩阵对一个点进行变换时，平移、旋转、缩放都会作用于该点。但如果是用于变换向量，那么平移的效果就会被忽略。如果不理解的话可以接着往下看。

### 分解基础变换矩阵

4X4 的矩阵可以用来表示平移、旋转、缩放变换。我们把表示纯平移、纯旋转、纯缩放的变换矩阵叫做基础变换矩阵。这种矩阵可以像下面这样分解：

$$
\begin{bmatrix}
   \boldsymbol M_{3 \times 3} & \boldsymbol t_{3 \times 1} \\
   \boldsymbol 0_{1 \times 3} & 1
\end{bmatrix}
$$

左上角的矩阵 $\boldsymbol M_{3 \times 3}$ 表示旋转和缩放，$\boldsymbol t_{3 \times 1}$ 用于表示平移，$\boldsymbol 0_{1 \times 3}$ 是零矩阵，右下角是标量 1。

### 平移矩阵

下面我们对一个点进行平移变换：

$$
\begin{bmatrix}
   1 & 0 & 0 & t_{x} \\
   0 & 1 & 0 & t_{y} \\
   0 & 0 & 1 & t_{z} \\
   0 & 0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
   x \\
   y \\
   z \\
   1
\end{bmatrix} =
\begin{bmatrix}
   x + t_{x} \\
   y + t_{y} \\
   z + t_{z} \\
   1
\end{bmatrix}
$$

从结果可以看出，点 $(x,y,z)$ 平移了 $(t_{x},t_{y},t_{z})$ 个单位。我们还可以顺便看下对向量进行平移变换的结果：

$$
\begin{bmatrix}
   1 & 0 & 0 & t_{x} \\
   0 & 1 & 0 & t_{y} \\
   0 & 0 & 1 & t_{z} \\
   0 & 0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
   x \\
   y \\
   z \\
   0
\end{bmatrix} =
\begin{bmatrix}
   x \\
   y \\
   z \\
   0
\end{bmatrix}
$$

可以看出，由于向量的第四个分量为 0，因此平移变换对于向量是不起作用的（向量没有位置概念）。

### 缩放矩阵

缩放变换如下：

$$
\begin{bmatrix}
   k_{x} & 0 & 0 & 0 \\
   0 & k_{y} & 0 & 0 \\
   0 & 0 & k_{z} & 0 \\
   0 & 0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
   x \\
   y \\
   z \\
   1
\end{bmatrix} =
\begin{bmatrix}
   k_{x}x \\
   k_{y}y \\
   k_{z}z \\
   1
\end{bmatrix}
$$

如果缩放系数 $k_{x}=k_{y}=k_{z}$，那么这种缩放就称为**统一缩放**。统一缩放的效果是将模型统一扩大或缩小，不会让模型失去原有比例。

缩放矩阵的逆矩阵如下：

$$
\begin{bmatrix}
   \frac{1}{k_{x}} & 0 & 0 & 0 \\
   0 & \frac{1}{k_{y}} & 0 & 0 \\
   0 & 0 & \frac{1}{k_{z}} & 0 \\
   0 & 0 & 0 & 1
\end{bmatrix}$$

?> 上述的缩放矩阵只能沿坐标轴方向缩放，如果要向任意方向缩放需要使用复合变换。

### 旋转矩阵

旋转矩阵比较麻烦，因为旋转的时候需要制定一个旋转轴，并且这个旋转轴还不一定就是坐标轴。当然，目前来说我们的旋转轴默认为 x、y、z 轴。

首先是绕着 x 轴旋转 $\theta$ 角度：

$$
\begin{bmatrix}
   1 & 0 & 0 & 0 \\
   0 & \cos\theta & -\sin\theta & 0 \\
   0 & \sin\theta & \cos\theta & 0 \\
   0 & 0 & 0 & 1
\end{bmatrix}$$

然后是 y 轴：

$$
\begin{bmatrix}
   \cos\theta & 0 & \sin\theta & 0 \\
   0 & 1 & 0 & 0 \\
   -\sin\theta & 0 & \cos\theta & 0 \\
   0 & 0 & 0 & 1
\end{bmatrix}$$

最后是 z 轴：

$$
\begin{bmatrix}
   \cos\theta & -\sin\theta & 0 & 0 \\
   \sin\theta & \cos\theta & 0 & 0 \\
   0 & 0 & 1 & 0 \\
   0 & 0 & 0 & 1
\end{bmatrix}$$

如果你不希望死记硬背，那么你可以换一种思路进行理解。首先，缩放和旋转是用不到四阶矩阵的，可以简化为三阶。接下来再将每一行视作是单独的基向量：

$$
\begin{bmatrix}
   \cos\theta & -\sin\theta & 0 \\
   \sin\theta & \cos\theta & 0 \\
   0 & 0 & 1 
\end{bmatrix} = 
\begin{bmatrix}
   \boldsymbol p \\
   \boldsymbol q \\
   \boldsymbol l
\end{bmatrix}
$$

由于我们当前是围绕 z 轴进行旋转，因此基向量 l 是不变的。同样的，对于基向量 p、q 而言，它们的 z 坐标也是不变的，因此矩阵可以简化为二阶矩阵：

$$
\begin{bmatrix}
   \cos\theta & -\sin\theta \\
   \sin\theta & \cos\theta
\end{bmatrix}
$$

看到这里，想必你就会很熟悉了。同样的，对于绕 x、y 轴的旋转矩阵也能够进行对应的简化。

?> 旋转矩阵的逆矩阵就是旋转相反角度的变换矩阵。

### 复合变换

复合变换就是把上述的三种变换综合起来，形成一个复杂的变换过程。例如，对一个模型进行缩放、旋转、平移，可以用以下公式计算：

$$ \boldsymbol p_{new} = \boldsymbol M_{translation} \boldsymbol M_{rotation} \boldsymbol M_{scale} \boldsymbol p_{old} $$

我们使用的是列矩阵，因此阅读顺序是从右到左，也就是先缩放再旋转最后平移。由于矩阵乘法不满足交换律，因此顺序很重要，绝大多数情况下变换的顺序是先缩放再旋转最后平移。

为什么这样呢？想象一下我们是按照先平移再缩放的顺序进行变换，假设模型处于原点，让它先平移 (0,0,5)，然后放大两倍，那么这样一来所有坐标就会变为原来的两倍，也就是说模型的位置处于 (0,0,10)。显然，这样是错误的，我们应该先让模型放大，然后再进行平移，这样的话模型的位置就不会出错。

除了注意变换的顺序以外，我们还要注意旋转的先后顺序。如果一个物体同时绕着 3 个轴进行旋转，那么旋转的顺序应该是怎么样的呢？

当我们直接给出 $(\theta_{x},\theta_{y},\theta_{z})$ 这样的旋转角度时，我们需要规定一个旋转顺序。Unity 的旋转顺序是 $zxy$，这个可以在官方文档里看到：

$$
\boldsymbol M_{rotatez} \boldsymbol M_{rotatex} \boldsymbol M_{rotatey} = 
\begin{bmatrix}
   \cos\theta_{z} & -\sin\theta_{z} & 0 & 0 \\
   \sin\theta_{z} & \cos\theta_{z} & 0 & 0 \\
   0 & 0 & 1 & 0 \\
   0 & 0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
   1 & 0 & 0 & 0 \\
   0 & \cos\theta_{x} & -\sin\theta_{x} & 0 \\
   0 & \sin\theta_{x} & \cos\theta_{x} & 0 \\
   0 & 0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
   \cos\theta_{y} & 0 & \sin\theta_{y} & 0 \\
   0 & 1 & 0 & 0 \\
   -\sin\theta_{y} & 0 & \cos\theta_{y} & 0 \\
   0 & 0 & 0 & 1
\end{bmatrix}
$$

有人可能会问，上面的顺序是不是反了，不是说列矩阵都要从右往左读吗？是这样的，我们在确定了旋转顺序后，有两种坐标系可以旋转。第一种是在旋转模型的时候不对当前坐标系进行旋转，第二种是在旋转模型的时候带着当前坐标系一起旋转。显然，这两种做法的结果是不一样的，但如果把它们的旋转顺序颠倒一下，那么这种两种做法就能得到相同结果。

说的详细点，在第一种情况下按照 $zxy$ 旋转与在第二种情况下按照 $yxz$ 旋转得到的结果是一样的。Unity 文档中给出的旋转顺序是针对第一种情况而言的。

### 正交投影矩阵

正交投影是指将向量投影至某个轴或者某个平面上，其形式类似于现实中的太阳光所产生的影子。

向 xy 平面的投影矩阵如下：

$$
\begin{bmatrix}
   1 & 0 & 0 \\
   0 & 1 & 0 \\
   0 & 0 & 0 
\end{bmatrix}
$$

向 xz 平面的投影矩阵如下：

$$
\begin{bmatrix}
   1 & 0 & 0 \\
   0 & 0 & 0 \\
   0 & 0 & 1 
\end{bmatrix}
$$

向 yz 平面的投影矩阵如下：

$$
\begin{bmatrix}
   0 & 0 & 0 \\
   0 & 1 & 0 \\
   0 & 0 & 1 
\end{bmatrix}
$$