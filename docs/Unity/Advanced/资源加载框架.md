# 资源加载框架

这一章的内容可能比较多，主要是总结一下我在平时的学习以及实习过程中积累下来的各类知识，然后把它们整合成一个简单的游戏框架。由于我目前正在用这个框架写毕设，源码的话得等我补充完毕后才会上传。

还是老样子，我只会介绍一下实现思路，具体的代码需要各位自行阅读。

?> 游戏框架的大小取决于项目的需求，并不是说一个框架就能够通吃所有游戏。

## 框架大纲

---

框架的基本功能大致如下，部分模块可能要之后才会补全：

* AssetBundle打包
* 资源加载
* 对象池管理
* UI管理
* 音效管理
* 特效管理
* 网络通信
...

## AssetBundle打包

---

一般的打包流程为：在编辑器中设置 AB 包名、生成 AB 包、根据 manifest 加载资源。这种做法的缺点很明显，需要开发者手动去设置包名，并且极易造成冗余。

打包脚本的流程为：通过脚本统一设置 AB 包名、处理冗余、生成自定义配置表、根据配置表加载资源。这种做法相比起上面那种，不仅大大减少了操作步骤，同时还能够解决冗余问题。

下面就来介绍一下打包脚本的各个环节是怎么实现的。

### 划分资源目录

在实际的项目开发过程中，美术通常会上传一大堆资源，这些资源有的会被用到，而有的则是压根就没有被用过。为了减小包体大小，我们需要明确哪些资源是游戏所必需的，也就是说需要动态加载的资源有哪些。

最容易想到的应该是 Prefab，其次就是 Sound、Shader、Texture 这类资源。材质、贴图等资源一般不会直接加载，通常是把它们挂载到 Model 上，然后把 Model 做成一个 Prefab 进行加载。

我的做法是把所有的 Prefab 单独进行打包，而诸如 Sound、Shader 等资源则是以文件夹为单位进行打包。如果 Prefab 太多的话，也可以文件夹形式进行打包。

?> 目录的划分仅供参考，请根据项目的实际需求进行修改。

### 设置包名并处理冗余

冗余的问题我在基础篇中讲过，对于没有被指定打包的外部资源，若存在多个 AB 包依赖它，打包时该资源就会被多次打包进依赖于它的 AB 包中，造成了资源冗余。说白了，要想解决这个问题，就必须要为所有的依赖项设置包名。

处理的步骤如下：

* 调用 `AssetDatabase.GetDependencies()` 获取依赖项
* 统一为这些依赖项设置包名
* 如果依赖项已存在于现有的包中，那么就不对其进行修改

这样一来，若多个包同时依赖于某个资源，那么该资源会被打进最早的包中，其它的包则只会引用最早的包。

### 生成配置表

Unity 在打包完毕后会自动生成资源配置表，不过为了方便开发者浏览所有的资源，最好还是自定义一个配置表。序列化方式有很多种，我这里采用的是 XML 和二进制，XML 用来阅读，二进制用于游戏加载。

配置表需要记录的信息可以参考 `.manifest` 文件，我这里给出一个范例：

* 资源文件相对于 Assets 目录的路径
* crc
* AB 包名
* 资源名称
* 依赖的 AB 包列表

打包脚本一共会经历两次过滤。第一次过滤是在设置包名的时候，目的是为了避免重复打包和重复设置包名。第二次过滤可选，目的是简化配置表，剔除掉不需要动态加载的资源。举个例子，材质、贴图等资源一般是不会直接加载的，它们通常跟随 Prefab 一起加载到游戏中，因此不必将它们写入到配置表中。

为了方便起见，我们可以实现把需要动态加载的资源的路径记录下来，在写入配置表时判断当前资源路径是否属于动态加载的资源路径，属于的话就将其写入。

关于路径的从属判断，我们不能够直接使用 `string.Contains()`，否则遇到下面这种情况时就会出错：

    路径A：Assets/Test
    路径B：Assets/TestTTT/a.prefab

显然，路径 B 并不属于路径 A，但是用 `Contains` 方法判断的结果为 `true`，理由是路径 A 和路径 B 都包含了相同的字符串。正确的做法应该是把路径 B 中与路径 A 相同的部分去除掉，如果路径 B 剩下的首字符为 `'/'`，那么路径 B 就属于路径 A。

```csharp
private static bool ContainsFileAB(string path)
{
    foreach (string abPath in allFileABList)
    {
        if (path == abPath || (path.Contains(abPath) && path.Replace(abPath, "")[0] == '/'))
        {
            return true;
        }
    }

    return false;
}
```

可以对比一下不过滤和过滤的差别：

![](http://cdn.fantasticmiao.cn/image/post/Unity/%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E6%A1%86%E6%9E%B6/01.png)

![](http://cdn.fantasticmiao.cn/image/post/Unity/%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E6%A1%86%E6%9E%B6/02.png)