# 基础光照模型

渲染图像最终的目的就是计算出每个像素的颜色并将之显示在屏幕上。从宏观上来说，像素的颜色一般由可见性以及光照计算来决定，而光照模型则是用来进行光照计算的。

## 光照原理

---

各位想必都学习过物理，那么关于光的有关性质应该是不会陌生的。我们之所以能够看到物体，是因为物体会发射或者反射光线，由我们人眼接收到并形成图像信号。当人们描述某个物体是蓝色时，是因为该物体吸收了其它的波长，并将大多数的蓝色波长反射了出去。为了在游戏中模拟这种真是的物理现象，我们需要对物理的本质有所了解。

通常而言，光照模拟需要考虑三种情况：

* 光线由光源发出。
* 光线被物体吸收或者散射到其他的方向。
* 摄像机吸收了光线，产生图像。

### 光源

为了将光源量化为一个可以描述的物理量，我们可以用**辐射度**来描述光照的强度，用 l 代表光照方向，那么辐射度就表示为在垂直于 l 的单位面积上单位时间内穿过的能量。当然，光照方向一般都是不垂直于物体表面的，所以我们需要进行一些计算。

假设光线之间的距离为 $d$，光线与物体表面的夹角 $\theta$，那么右图中光线在物体表面上的距离为 $d/\cos\theta$，其辐射度显然要比左图小。

![](http://cdn.fantasticmiao.cn/image/post/Unity/Advanced/%E5%9F%BA%E7%A1%80%E5%85%89%E7%85%A7%E6%A8%A1%E5%9E%8B/irradiance.png)

### 吸收和散射

光线与物体相交时通常会有两种情况：**散射**和**吸收**。

散射只改变光线的方向，而吸收则只改变光线的密度和颜色。光线在物体表面进行散射后，通常会有有两种方向：一种会散射到物体内部，即**折射**；另一种会散射到物体外部，即**反射**。对于不透明物体，光线经过折射后还会继续在物体内部碰撞，有可能会被物体吸收或者重新发射出物体表面。下图描述的就是不透明物体的情况。

![](http://cdn.fantasticmiao.cn/image/post/Unity/Advanced/%E5%9F%BA%E7%A1%80%E5%85%89%E7%85%A7%E6%A8%A1%E5%9E%8B/scattering.png)

为了进行区分，我们把物体表面的光线反射称为**高光反射**，把光线折射、吸收、从内部散射出物体表面称为**漫反射**。根据入射光线的数量和方向，可以计算出射光线的数量和方向，一般用**出射度**来描述。辐射度和出射度呈线性关系，它们的比值就是材质的漫反射和高光反射属性。

### 着色

**着色**是指根据材质属性、光源信息，使用一个公式来计算沿某个观察方向的出射度的过程。这个公式称之为**光照模型**。光照模型具有特定的含义，例如有些用于描述粗糙的物体表面，而有些则用于描述金属表面。

### BRDF光照模型

BRDF 光照模型用来描述模型上某个顶点的外观，它大多是以数学公式的形式进行表示。当给定入射光线的方向和辐射度之后，BRDF 可以给出在某个出射方向上光照的能量分布。

注意，这里我们探讨的都是前人总结的经验之谈，所有的参数都是理想化以及简化的，并不能真实地描述光线和物体的交互。当然，光是这些经验之谈就已经能够满足许多需求了，毕竟只要看起来是正确的就行了。

?> 本章只讨论基础的光照模型，更复杂更真实的模型会放到之后的笔记中。

## 标准光照模型

---

所谓的标准光照模型，就是重点关注那些直接从光源发射出来照射到物体表面后，经过物体一次反射就直接进入摄像机的光线。

标准光照模型将进入摄像机的光线分为四个部分，它们分别是：

* 自发光：当给定一个方向时，一个表面本身会向该方向发射多少辐射量。
* 高光反射：当光线从光源照射到模型表面时，该表面会在完全镜面反射方向散射多少辐射量。
* 漫反射：当光线从光源照射到模型表面时，该表面会向每个方向散射多少辐射量。
* 环境光：用于描述其他的间接光。

### 环境光

在真实世界中，物体经常会被各种间接光照亮，所以就算标准光照模型的重点在于直接光照，也不能够将环境光全部忽视掉。所谓的间接光照，通常是指光线会在多个物体表面反射，并最终进入到摄像机中。举个例子，如果一个红色的物体反射了光线，那么被间接光所照射到的物体也会带上一点红色。

在标准光照模型中，环境光被用来模拟真是的间接光照。它通常是一个全局变量，所有的物体都会使用这个环境光，因此效果也是比较简单。

### 自发光

直接由光源进入摄像机的光线可以被称为自发光。由于自发光没有经过反射，所以它可以直接使用该材质的自发光颜色。

在 Unity 中，自发光表面其实并不能够照亮周围的表面，因为它并没有被当成一个光源。只有当你开启了全局光照之后，才能够模拟自发光物体对周围物体表面的影响。

### 漫反射

漫反射用于描述物体表面随机散射到各个方向的辐射度。由于反射是随机的，所以可以认为任何反射方向上的分布都是一样的。

漫反射遵循**兰伯特定律**，即反射光线强度与表面法线和光源方向之间的夹角的余弦值成正比。设 $n$ 为表面法线，$I$ 为指向光源的单位矢量，$m_{diffuse}$ 是材质的漫反射颜色，$c_{light}$ 是光源颜色，则有以下计算公式：

$$ c_{diffuse}=(c_{light} \cdot m_{diffuse})max(0, n \cdot I) $$

为了避免法线和光源方向点乘的结果为负值，这里要用 `max` 函数进行取值判断，避免物体被从后面来的光源照亮。

### 高光反射

这里的高光反射其实是一种经验模型，与真实情况的高光反射并不一样。它一般用来计算完全镜面反射的光线，比如金属表面的反光。

计算高光反射需要知道表面法线、视角方向、光源方向、反射方向等，不过由于反射方向可以经过计算得到，因此我们一般只需要知道三个矢量即可。

假设 $m_{gloss}$ 是材质的光泽度，它用于控制反射形成的亮点大小，光泽度越高亮点越小。$m_{spscular}$ 是材质的高光反射颜色，用于控制该材质对高光反射的强度和颜色。$c_{light}$ 是光源的颜色和强度。那么我们有如下计算公式：

$$ c_{spscular}=(c_{light} \cdot m_{spscular})max(0, \boldsymbol v \cdot \boldsymbol r)^{m_{gloss}} $$

下图则是该公式对应的模型示意图（Phong 模型）：

![](http://cdn.fantasticmiao.cn/image/post/Unity/Advanced/%E5%9F%BA%E7%A1%80%E5%85%89%E7%85%A7%E6%A8%A1%E5%9E%8B/specular.png)

当然，我们也可以不计算反射方向，而是引入一个新的矢量 $\boldsymbol h$，它是由矢量 $\boldsymbol v$ 和矢量 $\boldsymbol I$ 的取平均再归一化得到的。即

$$ \boldsymbol h=\frac{\boldsymbol v + I}{|\boldsymbol v + I|} $$

然后我们就能够得到如下计算公式：

$$ c_{spscular}=(c_{light} \cdot m_{spscular})max(0, \boldsymbol n \cdot \boldsymbol h)^{m_{gloss}} $$

下图则是该公式对应的模型示意图（Blinn 模型）：

![](http://cdn.fantasticmiao.cn/image/post/Unity/Advanced/%E5%9F%BA%E7%A1%80%E5%85%89%E7%85%A7%E6%A8%A1%E5%9E%8B/Blinn.png)

一般来说，当摄像机和光源距离模型足够远时，Blinn 模型要更快一些，因为此时可以认为 $\boldsymbol v$ 和 $\boldsymbol r$ 都是定值，也就是说 $\boldsymbol h$ 是常量。